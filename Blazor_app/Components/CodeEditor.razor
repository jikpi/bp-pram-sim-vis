@using Blazor_app.Services
@using PRAM_lib.Machine
@inject CodeEditorService codeEditor
@inject PramMachine pramMachine

<style>

</style>


@if (codeEditor.EditMode)
{
    <textarea @bind="codeEditor.Code" rows="@textAreaRows" class="form-control"></textarea>
}
else
{
    <div class="code-compiled-code-container">
        @foreach (var line in codeEditor.CompiledLines)
        {
            <div class="@GetLineClass(line.Key)">
                @line.Value
            </div>
        }
    </div>
}

@code {
    private int textAreaRows => codeEditor.Code.Split('\n').Length;

    protected override void OnInitialized()
    {
        codeEditor.EditorStateChanged += StateHasChanged;
    }

    private string GetLineClass(int lineIndex)
    {
        if (lineIndex == codeEditor.CurrentExecutingLine)
        {
            return "code-current-line";
        }

        if (pramMachine.InstructionRegex.Comment.IsMatch(codeEditor.CompiledLines[lineIndex]))
        {
            return "code-comment";
        }

        if (pramMachine.InstructionRegex.IfJumpTo.IsMatch(codeEditor.CompiledLines[lineIndex]))
        {
            return "code-jump";
        }

        if (pramMachine.InstructionRegex.JumpToLabel.IsMatch(codeEditor.CompiledLines[lineIndex]))
        {
            return "code-label-jump";
        }



        return "";
    }

    public void Dispose()
    {
        codeEditor.EditorStateChanged -= StateHasChanged;
    }
}